<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="index.css" />
    <title>LIFF Starter</title>

    <!-- CDNエッジパス -->
<!--
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
-->

    <!-- CDN固定パス -->
    <script src="https://static.line-scdn.net/liff/edge/2.27.3/sdk.js"></script>

<!--
    他にもこんなのあるけど使い方がわからない・・・
    <script src="https://static.line-scdn.net/liff/edge/2/non-ios-extensions_2_22_0.js" type="text/javascript"></script>
    <script src="https://static.line-scdn.net/liff/sdk/v2/liff.js"></script>
-->

  </head>
  <body>
    <p style="text-indent: 2ch"><button  onclick="window.location.reload();">リロード</button></p>
    <div style="text-indent: 2ch">
      <h1>LIFF APIの確認画面</h1>
       <div>
        <p>LIFF ID: <span id="liffid"></span></p>
      </div>
      <div>
        <p>ステータス: <span id="status">初期化中...</span><button onclick="click_login()">ログイン</button><button onclick="click_logout()">ログアウト</button></p>
      </div>
      
       <p>以下の項目で(*)がつくものは、liff.initが完了する前でも利用できる（らしい）</p>
      
      <div>
        <p>プロフィール: <button onclick="click_LiffProfile()">更新</button></p>
        <p style="text-indent: 4ch"><textarea id="profile" rows="5" cols="80"></textarea></p>
      </div>
      <div>
        <p>OS(*): <span id="os"></span><button onclick="click_OS()">更新</button></p>
      </div>
       <div>
        <p>LINEアプリの言語(*): <span id="app-language"></span><button onclick="click_AppLang()">更新</button></p>
      </div>
       <div>
        <p>LIFF SDKのバージョン(*): <span id="sdk-version"></span><button onclick="click_SdkVersion()">更新</button></p>
      </div>
       <div>
        <p>LINE のバージョン(*): <span id="line-version"></span><button onclick="click_LineVersion()">更新</button></p>
      </div>
       <div>
        <p>LIFFブラウザの確認(*): <span id="isInClient"></span><button onclick="click_IsInClient()">更新</button></p>
      </div>
       <div>
        <p>コンテキスト: <button onclick="click_Context()">更新</button></p>
        <p style="text-indent: 4ch"><textarea id="context" rows="5" cols="80"></textarea></p>
      </div>
       <div>
        <p>API()の有効性: <button onclick="click_IsApiAvailable()">更新</button></p>
        <p style="text-indent: 4ch">shareTargetPicker : <span id="available_shareTargetPicker"></span></p>
        <p style="text-indent: 4ch">createShortcutOnHomeScreen : <span id="available_createShortcutOnHomeScreen"></span></p>
        <p style="text-indent: 4ch">multipleLiffTransition : <span id="available_multipleLiffTransition"></span></p>
      </div>
       <div>
        <p>アクセストークン: <button onclick="click_AccessToken()">更新</button></p>
        <p style="text-indent: 4ch"><textarea id="accessToken" rows="5" cols="80"></textarea></p>
      </div>
       <div>
        <p>IDトークン: <button onclick="click_IDToken()">更新</button></p>
        <p style="text-indent: 4ch"><textarea id="idTokenJWT" rows="5" cols="80"></textarea></p>
        <p style="text-indent: 4ch">解析 : </p>
        <p style="text-indent: 4ch"><textarea id="idToken" rows="5" cols="80"></textarea></p>
      </div>
       <div>
        <p>DecodedIDトークン: <button onclick="click_decodedIDToken()">更新</button></p>
        <p style="text-indent: 4ch"><textarea id="decodedIDToken" rows="5" cols="80"></textarea></p>
        <p style="text-indent: 4ch">発行日時 : <span id="decodedIDToken_iat"></span></p>
        <p style="text-indent: 4ch">有効期限 : <span id="decodedIDToken_exp"></span></p>
      </div>
       <div>
        <p>権限の付与に同意したスコープ: <span id="permission_grantedAll"></span><button onclick="click_permission_grantedAll()">更新</button></p>
      </div>
       <div>
        <p>指定した権限の付与に同意したスコープ: <span id="permission_query"></span><button onclick="click_permission_query()">更新</button></p>
      </div>
       <div>
        <p><button onclick="click_permission_requestAll()">同意画面の表示</button></p>
      </div>
       <div>
        <p>LINE公式アカウントの友だち関係: <span id="friendship"></span><button onclick="click_frendship()">更新</button></p>
      </div>
       <div>
        <p><button onclick="click_openURL()">URLを開く</button></p>
        <p style="text-indent: 4ch">URL: <textarea id="openURL" rows="1" cols="80">https://line.me</textarea></p>
      </div>
       <div>
        <p><button onclick="click_close()">画面を閉じる</button></p>
      </div>
       <div>
        <p>トークルームにメッセージを送信: <button onclick="click_sendMessages()">送信</button></p>
        <p style="text-indent: 4ch"><textarea id="messageForSendMessages" rows="15" cols="80"></textarea></p>
      </div>
       <div>
        <p><button onclick="click_shareTargetPicker()">シェアーターゲットピッカーを開く</button></p>
      </div>
       <div>
        <p><button onclick="click_scanQR()">QRコードリーダを開く</button></p>
      </div>
       <div>
        <p>パーマネントリンクを取得: <button onclick="click_createUrlBy()">取得</button></p>
        <p style="text-indent: 4ch">変換元：<textarea id="currentHref" rows="1" cols="80"></textarea></p>
        <p style="text-indent: 4ch">変換先：<textarea id="createUrlBy" rows="1" cols="80"></textarea></p>
      </div>
       <div>
        <p><button onclick="click_createShortCutOnHomeScreen()">ホーム画面のショートカットを作る</button></p>
      </div>
    </div>
    
    <!--
    // スクリプト
    -->
    <script>
      
      //
      // LIFF APIでエラーを返すときは、LiffErrorオブジェクトが返る
      // {
      //   code: string エラーコード
      //   message: string エラーメッセージ
      //   cause: Unknown(含まれないことがある） エラーの原因
      // }
      // 
      // https://developers.line.biz/ja/reference/liff/#liff-errors
      //
      function alertLiffError(err) {
        alert(
          "code: " + err.code + "\n" +
          "message: " + err.message + "\n" + 
          "cause: " + err.cause);
      }
      
      function parseJwtMember(base64Url) {
        // '-'を'+'に、'_'を'/'に置き換え
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        
        // パディング補正
        while (base64.length % 4) {
          base64 += '=';
        }
        
        // URIエンコード
        let url = atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join('');
        
        // JSON形式にデコード
        let json = decodeURIComponent(url);
        return json;
      }
      
      function parseJwt(token) {
        let ary = token.split('.');
        let header = JSON.parse(parseJwtMember(ary[0]));
        let payload = JSON.parse(parseJwtMember(ary[1]));
        return { "header" : header, "payload" : payload, "signature(undecoded)": ary[2] };
      }

      //
      // LIFF初期化処理
      //
      function initializeLiff(liffid, allowLogin) {
        // liff.init
        //   config [必須]
        //     .liffid [必須] LIFFアプリID
        //     .withLoginOnExternalBrowser 外部ブラウザでのLIFFアプリ初期化時にloginメソッドを自動で実行するかどうか。デフォルト値はfalse。
        liff.init({
          liffId: liffid,
          withLoginOnExternalBrowser: allowLogin
        })
        .then(() => {
          // withLoginOnExternalBrowserがtrueの時はログイン済み、falseの時は未ログインになる
          update_status(liff.isLoggedIn());
        })
        .catch((err) => {
          document.getElementById('status').textContent = `初期化エラー: ${err.code}`;
          console.error("LIFF Initialization failed", err);
        });
        
        // liff.initの終了を待って、任意の処理を実行するときにreadyプロパティを使う
        liff.ready
        .then(() => {
          document.getElementById('liffid').textContent = liff.id;
        });
      }
      
      function update_status(loggined) {
        document.getElementById('status').textContent = loggined ? 'ログイン' : '未ログイン';
      }
      
      //
      // ログイン(liff.login)
      //
      function click_login() {
        if (liff.isLoggedIn()) return;
          liff.login();
          //liff.login({
          //  redirectUri: "https://supervnyan-debug.github.io/lesson_lineminiapp/index3.html"
          //});
          update_status(liff.isLoggedIn());
      }
      
      //
      // ログアウト(liff.logout)
      //
      function click_logout() {
        if (!liff.isLoggedIn()) return;
        liff.logout();
        update_status(false);
      }

      //
      // プロフィール (liff.getProfile()
      //
      function click_LiffProfile() {
        liff.getProfile()
        .then(profile => {
          // プロフィール情報を画面に表示
          document.getElementById('profile').value = JSON.stringify(profile, null, 2);
          console.log('Profile fetched:', profile);
        })
        .catch((err) => {
          document.getElementById('profile').value = 'プロフィールの取得に失敗しました';
          console.error("Error getting profile", err);
          alertLiffError(err);
        });
      }
      
      //
      // OS(liff.getOS)
      //
      function click_OS() {
        document.getElementById('os').textContent = liff.isLoggedIn()? liff.getOS(): "---";
      }
      
      //
      // LINEアプリの言語(liff.getOS)
      //
      function click_AppLang() {
        // liff.getLanguage()は非推奨となり、liff.getAppLanguageを呼ぶそうです。
        document.getElementById('app-language').textContent = liff.getAppLanguage();
      }
      
      //
      // LIFF SDKのバージョン(liff.getVersion)
      //
      function click_SdkVersion() {
        document.getElementById('sdk-version').textContent = liff.getVersion();
      }
      
      //
      // LINE のバージョン(liff.getLineVersion)
      //
      function click_LineVersion() {
        // LIFFブラウザでは動くが、外部ブラウザでは空文字列
        document.getElementById('line-version').textContent = liff.getLineVersion();
      }
      
      //
      // LIFFブラウザであるかの確認(liff.isInClient)
      //
      function click_IsInClient() {
        // このメソッド使うことで、外部ブラウザで開かれた場合に機能抑制の判断が可能になります。
        document.getElementById('isInClient').textContent = liff.isInClient()? "LIFFブラウザ": "外部ブラウザ or LINE内ブラウザ";
      }
      
      //
      // コンテキストの確認（liff.getContext）
      //
      function click_Context() {
        // エンコードされていないJSONオブジェクトが返ってくる
        // 取得できるデータは、部分的に別の呼び出しで得る値を使った方が良くなっているので使いどころに注意
        document.getElementById('context').value = JSON.stringify(liff.getContext(), null, 2);
      }

      //
      // 幾つかのAPIの有効性チェック（liff.isApiAvailable）
      //
      function click_IsApiAvailable() {
        // 取得できるデータは、部分的に別の呼び出しで得る値を使った方が良くなっているので使いどころに注意
        document.getElementById('available_shareTargetPicker').textContent = liff.isApiAvailable("shareTargetPicker");
        document.getElementById('available_createShortcutOnHomeScreen').textContent = liff.isApiAvailable("createShortcutOnHomeScreen");
        document.getElementById('available_multipleLiffTransition').textContent = liff.isApiAvailable("multipleLiffTransition");
      }

      //
      // 現在のユーザのアクセストークン（liff.getAccessToken）
      //
      function click_AccessToken() {
        // アクセストークンはJWTではありません
        document.getElementById('accessToken').value = liff.getAccessToken();
      }
      
      //
      // 現在のユーザのIDトークン（liff.getIDToken）
      //
      function click_IDToken() {
        let idTokenObj = liff.getIDToken();
        document.getElementById('idTokenJWT').value = idTokenObj;
        if (idTokenObj === null || idTokenObj === undefined)
        {
          document.getElementById('idToken').value = "<null>";
        }
        else
        {
          // IDトークンはJWT
          let idtoken = parseJwt(idTokenObj);
          document.getElementById('idToken').value = JSON.stringify(idtoken, null, 2);
        }
      }
      
      //
      // 現在のユーザのIDトークンのペイロード（liff.getDecodedIDToken）
      //
      function click_decodedIDToken() {
        // ペイロード部分がエンコードされていないJSONオブジェクトが返ってくる
        let decodedToken = liff.getDecodedIDToken();
        document.getElementById('decodedIDToken').value = JSON.stringify(decodedToken, null, 2);
        
        // 時間は1970年からの経過秒数なのでミリ秒変換が必要
        let date = new Date(0);
        document.getElementById('decodedIDToken_iat').textContent = new Date(date.getTime() + decodedToken.iat * 1000).toString();
        document.getElementById('decodedIDToken_exp').textContent = new Date(date.getTime() + decodedToken.exp * 1000).toString();
      }
      
      //
      // 現在のユーザが権限の付与に同意したスコープの一覧(liff.permission.getGrantedAll)
      //
      function click_permission_grantedAll() {
        liff.permission.getGrantedAll()
        .then((scopes) => {
          document.getElementById('permission_grantedAll').textContent = scopes;
        })
        .catch((err) => {
          document.getElementById('permission_grantedAll').textContent = "grantedAll is failed: " + err.message;
        });
      }
      
      //
      // 現在のユーザが権限の付与に同意したスコープ(liff.permission.query)
      //
      function click_permission_query() {
        let items = [ "profile", "chat_message.write", "openid", "email" ];
        let message = "";
        items.map(function(i) {
          liff.permission.query(i)
          .then((permissionStatus) => {
            message += "{ " + i + " : " +  permissionStatus["state"] + " } ";
            document.getElementById('permission_query').textContent = message;
            return i;
          });
        });
      }
      
      //
      // 「アクセス許可要求画面」の表示(liff.permission.requestAll)
      //
      function click_permission_requestAll() {
        // アクセス許可がまだないか確認してから画面を表示する
        liff.permission.query("profile")
        .then((permissionStatus) => {
          if (permissionStatus.state === "prompt") {
            // Promiseなので、アクセス許可済みの場合はrejectされるので注意
            liff.permission.requestAll();
          }
          else
          {
            alert("アクセス許可の同意済み");
          }
        });
      }
      
      //
      // ユーザーとLINE公式アカウントの友だち関係(liff.getFriendship)
      //
      function click_frendship() {
        // LINEログインチャネルがLINE公式アカウントとリンクされていないとrejectされます
        liff.getFriendship()
        .then((data) => {
          document.getElementById('friendship').textContent = data.friendFlag;
        })
        .catch((err) => {
          document.getElementById('friendship').textContent = err.message;
        });
      }
      
      //
      // 指定したURLのウィンドウを開く(liff.openWindow()
      //
      function click_openURL() {
        let openurl = document.getElementById('openURL').value;
        liff.openWindow({
          url: openurl,
          external: true,
        });
      }
      
      //
      // 画面を閉じる(liff.closeWindow)
      //
      function click_close() {
        liff.closeWindow();
      }
      
      //
      // トークルームにメッセージを送信する(liff.sendMessages)
      //
      function click_sendMessages() {
        let message = document.getElementById('messageForSendMessages').value;
        liff.sendMessages([{
          type: "text",
          text: "Nice me too!",
        }])
        .then(() => {
          alert('successs!');
        })
        .catch((err)=>{
          alertLiffError(err);
        });
      }
      
      //
      // ターゲットピッカーを表示する(liff.shareTargetPicker)
      //
      function click_shareTargetPicker() {
        liff.shareTargetPicker(
          [{
            type: "text",
            text: "Hello, World!",
          },],
          {
            isMultiple: true,
          },)
        .then(function (res) {
          if (res) {
            // succeeded in sending a message through TargetPicker
            console.log(`[${res.status}] Message sent!`);
          } else {
            // sending message canceled
            console.log("TargetPicker was closed!");
          }
        })
        .catch(function (err) {
          // something went wrong before sending a message
          alertLiffError(err);
        });
      }
      
      //
      // QRコードリーダを表示(liff.scanCodeV2)
      //
      function click_scanQR() {
        //if (!liff.isLoggedIn() || liff.getOS() == "web") {
        //  alert("ログイン、かつPC以外でないと使えません");
        //  return;
        //}
        
        liff.scanCodeV2()
        .then((result) => {
          alert(result.value);
        })
        .catch((error) => {
          alertLiffError(error);
        });
      }
      
      //
      // パーマネントリンクを取得(liff.permanentLink.createUrlBy)
      //
      function click_createUrlBy() {
        liff.permanentLink.createUrlBy(document.getElementById('currentHref').value)
        .then((permanentLink)=>{
          document.getElementById('createUrlBy').value = permanentLink;
        })
        .catch((err)=>{
          alertLiffError(err);
        });
      }
      
      //
      // ホーム画面のショートカットを作る(liff.createShortcutOnHomeScreen)
      //
      function click_createShortCutOnHomeScreen() {
        // LIFF URL or パーマネントリンク or LINEミニアプリのエンドポイントURL or LINEミニアプリのエンドポイントURLから始まるURL
        //let targetURL = document.getElementById('currentHref').value;
        let targetURL = document.getElementById('createUrlBy').value;	
        let paramObj = {
          url: targetURL
        };
        liff.createShortcutOnHomeScreen(paramObj)
        .then(()=>{
          alert('show dialog');
        })
        .catch((err)=>{
          alertLiffError(err);
        });
      }
      
      // アプリ起動時にLIFF初期化関数を実行
      const MY_LIFF_ID = "2008528173-5R3vq0Lm"; // ★★ このWebページをエンドポイントとするLINEログインチャネルのLIFF IDに置き換えてください ★★
      const autoLogin = false;                  // 画面を開くと同時にログインするかどうか（外部ブラウザのみ影響）
      initializeLiff(MY_LIFF_ID, autoLogin);
      
      // パーマネントリンクの変換元の初期値を現在のページのURLにしておく
      document.getElementById('currentHref').value = window.location.href.split('?')[0];
      
      // LIFF SDK が表示する文言の言語が指定できるらしいが、影響がわからなかった
      //liff.i18n.setLang("fr");
    </script>
  </body>
</html>
